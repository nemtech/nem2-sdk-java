/*
 * Copyright 2020 NEM
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package io.nem.core.crypto;

import io.nem.core.utils.ConvertUtils;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.IntStream;
import java.util.stream.Stream;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

/**
 *
 */
public class HashesTypescriptValidationTest {

    private static Stream<Arguments> testHashersValues() {
        List<Arguments> params = new ArrayList<>();

        List<String> inputs = Arrays.asList("", "CC", "41FB", "1F877C", "C1ECFDFC",
            "9F2FCC7C90DE090D6B87CD7E9718C1EA6CB21118FC2D5DE9F97E5DB6AC1E9C10",
            "ABCD,12,4567");

        List<String> sha3_256Result = Arrays
            .asList("A7FFC6F8BF1ED76651C14756A061D662F580FF4DE43B49FA82D80A4B80F8434A",
                "677035391CD3701293D385F037BA32796252BB7CE180B00B582DD9B20AAAD7F0",
                "39F31B6E653DFCD9CAED2602FD87F61B6254F581312FB6EEEC4D7148FA2E72AA",
                "BC22345E4BD3F792A341CF18AC0789F1C9C966712A501B19D1B6632CCD408EC5",
                "C5859BE82560CC8789133F7C834A6EE628E351E504E601E8059A0667FF62C124",
                "2F1A5F7159E34EA19CDDC70EBF9B81F1A66DB40615D7EAD3CC1F1B954D82A3AF",
                "427BC15219F70D86BAEDDC453D463C45E1F8C128872305778D6C7B0A6279AE9C");

        List<String> sha3_512Result = Arrays
            .asList(
                "A69F73CCA23A9AC5C8B567DC185A756E97C982164FE25859E0D1DCC1475C80A615B2123AF1F5F94C11E3E9402C3AC558F500199D95B6D3E301758586281DCD26",
                "3939FCC8B57B63612542DA31A834E5DCC36E2EE0F652AC72E02624FA2E5ADEECC7DD6BB3580224B4D6138706FC6E80597B528051230B00621CC2B22999EAA205",
                "AA092865A40694D91754DBC767B5202C546E226877147A95CB8B4C8F8709FE8CD6905256B089DA37896EA5CA19D2CD9AB94C7192FC39F7CD4D598975A3013C69",
                "CB20DCF54955F8091111688BECCEF48C1A2F0D0608C3A575163751F002DB30F40F2F671834B22D208591CFAF1F5ECFE43C49863A53B3225BDFD7C6591BA7658B",
                "D4B4BDFEF56B821D36F4F70AB0D231B8D0C9134638FD54C46309D14FADA92A2840186EED5415AD7CF3969BDFBF2DAF8CCA76ABFE549BE6578C6F4143617A4F1A",
                "B087C90421AEBF87911647DE9D465CBDA166B672EC47CCD4054A7135A1EF885E7903B52C3F2C3FE722B1C169297A91B82428956A02C631A2240F12162C7BC726",
                "BD4DA7781E35E2D404CA8F16D9DEDA11BD5B1CA1A433520546F921B4A58D5E92C763AACB914238575811B4D23D6200E1DBEA90D8F5C605D32796C3D88C800ADF");

        List<String> sha512Result = Arrays
            .asList(
                "CF83E1357EEFB8BDF1542850D66D8007D620E4050B5715DC83F4A921D36CE9CE47D0D13C5D85F2B0FF8318D2877EEC2F63B931BD47417A81A538327AF927DA3E",
                "62B9F8C512899CCCAD9AFB9F5AF8AE591F36E2B0588FD02510735EB543FCD5167F5058F468EC3CFB56CC4CFBBD43BDA37F3DBF2496E5895139D15A70367AB9F0",
                "F32AFB62ADEF2F4579456D2DBDA268897737C6B0185C0858BE369923E8AD40C15F9D3691837B49278DE2BAAA46DF77EEA8F3E713A7466CFD580DA9D28C73F283",
                "45BCC9D1F340CDD119FA1AFCC4F7AC657FA2D0BCA5852498EEE9C9F02F93EB2B1350E1C9567F6F18CCC5576D36812F686F31C26E2EFA6BBEE9FC7F5F5FFF7FA9",
                "0068125B83FBA7690978D5B591D5E7644BBD7ADF8011DD592D44F269DC31B3873136121872B2C8FAE70E2614266BF46ABB374006FE82CECEDFAD2644FECF140A",
                "FF6EBF72E7E9BC05E06A3DDBAC4298B68DCF50374BD74E910977A496F41270931268FABB3774B73EEC64E5D729C75D0887112E2FAD4DFA7DCEB8D1D97A3DFE44",
                "5D91F6ADB029258D66EAA67451ED4E3CAD25EC1D2D62627B0575A1DAB3A7757FD9ED02B147B27CB877B3DEE7487A095905AEA1FDB1375C30B102BCF90C6EC646");

        List<String> hash256Result = Arrays
            .asList(
                "F8BBB0CCB2491CA29A3DF03D6F92277A4F3574266507ACD77214D37ECA3F3082",
                "8266C3C7FB0E3EA25D676039A624F5EAAA7B08008037742DD53E9A14823B67C2",
                "32C822430DDAE71DC4E142FFE9CDC4AF5AB0CB9F8336BCC71CC74537D0F16E58",
                "7E5D2F4E92F559F6EBD4B71A27DD17196A1291B301B8CC0B202F5FE7FD0E5D96",
                "CF582B0B152368B0831F870DAEECB11BC54581681361A4528E8189785D13D267",
                "050080ABD9C4EC49AD7EBFD4136179BF445FF5F2B15A022C57D4E022605FBF20",
                "0B82AE38620F3F92EB00D0E956F88D7A6A78D5275C94F931561629B992176319");

        List<String> keccak256Results = Arrays
            .asList(
                "C5D2460186F7233C927E7DB2DCC703C0E500B653CA82273B7BFAD8045D85A470",
                "EEAD6DBFC7340A56CAEDC044696A168870549A6A7F6F56961E84A54BD9970B8A",
                "A8EACEDA4D47B3281A795AD9E1EA2122B407BAF9AABCB9E18B5717B7873537D2",
                "627D7BC1491B2AB127282827B8DE2D276B13D7D70FB4C5957FDF20655BC7AC30",
                "B149E766D7612EAF7D55F74E1A4FDD63709A8115B14F61FCD22AA4ABC8B8E122",
                "24DD2EE02482144F539F810D2CAA8A7B75D0FA33657E47932122D273C3F6F6D1",
                "F7109E626287D2FE00E05281F0E8EBF2FEDBCFDE5FA1F2667E2055309092BFB3");

        List<String> keccak512Results = Arrays
            .asList(
                "0EAB42DE4C3CEB9235FC91ACFFE746B29C29A8C366B7C60E4E67C466F36A4304C00FA9CAF9D87976BA469BCBE06713B435F091EF2769FB160CDAB33D3670680E",
                "8630C13CBD066EA74BBE7FE468FEC1DEE10EDC1254FB4C1B7C5FD69B646E44160B8CE01D05A0908CA790DFB080F4B513BC3B6225ECE7A810371441A5AC666EB9",
                "551DA6236F8B96FCE9F97F1190E901324F0B45E06DBBB5CDB8355D6ED1DC34B3F0EAE7DCB68622FF232FA3CECE0D4616CDEB3931F93803662A28DF1CD535B731",
                "EB7F2A98E00AF37D964F7D8C44C1FB6E114D8EE21A7B976AE736539EFDC1E3FE43BECEF5015171E6DA30168CAE99A82C53FA99042774EF982C01626A540F08C0",
                "952D4C0A6F0EF5CE438C52E3EDD345EA00F91CF5DA8097C1168A16069E958FC05BAD90A0C5FB4DD9EC28E84B226B94A847D6BB89235692EF4C9712F0C7030FAE",
                "1EAFEDCE7292BA73B80AE6151745F43AC95BFC9F31694D422473ABCA2E69D695CB6544DB65506078CB20DBE0762F84AA6AFD14A60AB597955BE73F3F5C50F7A8",
                "606A7B3E93570BC8833B9C568BE5111C37A6C7355FED878F135764044A3BB0D9D0CBDF397C72A731A6D5608F3A6B244293818A4D8D16840087809B4D33041999");

        List<String> hash160Results = Arrays
            .asList(
                "BA084D3F143F2896809D3F1D7DFFED472B39D8DE",
                "6D5914CA0B1C7EC9F25B976F6E405CA60BC93283",
                "4E20B2B1AF7F39B2A4E2114406838C1784978979",
                "2F79F0278AFCA8BB7A24487BE75C517F0367B8A2",
                "16A85F134EF46C2FF70163DC22963BE583727AE0",
                "BF6029B29DF43C54425549867DB1EC46478A9653",
                "DCB60AB6DDB5A3A35D62CA60E2DB675341DBCDD6");

        params.addAll(createParams("sha3_256", Hashes::sha3_256, inputs, sha3_256Result));
        params.addAll(createParams("sha3_512", Hashes::sha3_512, inputs, sha3_512Result));
        params.addAll(createParams("sha512", Hashes::sha512, inputs, sha512Result));
        params.addAll(createParams("hash256", Hashes::hash256, inputs, hash256Result));
        params.addAll(createParams("keccak256", Hashes::keccak256, inputs, keccak256Results));
        params.addAll(createParams("keccak512", Hashes::keccak512, inputs, keccak512Results));
        params.addAll(createParams("hash160", Hashes::hash160, inputs, hash160Results));
        return params.stream();
    }

    private static List<Arguments> createParams(String name, Hasher hasher, List<String> inputs,
        List<String> sha512Result) {
        return IntStream.range(0, inputs.size())
            .mapToObj(
                i -> Arguments
                    .of(namedHasher(hasher, name), inputs.get(i), sha512Result.get(i)))
            .collect(Collectors.toList());
    }

    private static Hasher namedHasher(Hasher delegate, String name) {
        return new Hasher() {
            @Override
            public byte[] hash(byte[]... inputs) {
                return delegate.hash(inputs);
            }

            @Override
            public String toString() {
                return name;
            }
        };
    }


    @ParameterizedTest
    @MethodSource("testHashersValues")
    void testHashers(Hasher hasher, String input, String expectedHash) {
        String hash = basicHash(hasher, input);
        Assertions.assertEquals(expectedHash.toUpperCase(), hash.toUpperCase());
    }

    String basicHash(Hasher hasher, String values) {
        byte[][] inputs = Arrays.stream(values.split(",")).map(ConvertUtils::fromHexToBytes)
            .toArray(this::create);
        return ConvertUtils.toHex(hasher.hash(inputs));
    }

    @Test
    void SHA256Hash() {
        Assertions.assertEquals("E618ACB2558E1721492E4AE3BED3F4D86F26C2B0CE6AD939943A6A540855D23F",
            ConvertUtils.toHex(Hashes.sha256ForSharedKey("string-or-buffer".getBytes()))
                .toUpperCase());
    }

    byte[][] create(int size) {
        return new byte[size][];
    }
}
